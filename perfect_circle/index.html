<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Perfect Circle Challenge</title>
<style>
    html, body {
        margin: 0;
        overflow: hidden;
        height: 100%;
        background: linear-gradient(45deg, #00111a, #001f33, #00334d, #004466);
        background-size: 400% 400%;
        /* animation: gradientShift 25s ease infinite; */
        font-family: 'Segoe UI', sans-serif;
        color: white;
        user-select: none;
    }

    #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: crosshair;
        touch-action: none;
    }

    #hud {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        z-index: 2;
    }

    #score {
        font-size: 42px;
        font-weight: 900;
        color: #00fff6;
        text-shadow: 0 0 15px #00fff6;
        transition: 0.4s;
    }

    #details {
        font-size: 16px;
        color: #aaa;
        margin-top: 6px;
    }
  <div id="leaderboard" style="margin-top:12px;font-size:14px;color:#ccc;"></div>

    #reset {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(90deg, #0ff, #09f);
        border: none;
        padding: 12px 36px;
        font-size: 18px;
        border-radius: 12px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
        z-index: 2;
    }

    #reset:hover {
        transform: translateX(-50%) scale(1.1);
        background: linear-gradient(90deg, #09f, #0ff);
    }

    #instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 24px;
        color: #ccc;
        opacity: 0.85;
        animation: pulse 2s infinite;
        z-index: 1;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 0.4; }
    }
    @keyframes fadeOut {
        from {opacity: 1; transform: translate(-50%, -50%) scale(1);}
        to {opacity: 0; transform: translate(-50%, -50%) scale(1.3);}
    }

    #particles {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 0;
    }
    #restartHint {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        color: #888;
        font-size: 16px;
        opacity: 0;
        transition: opacity 0.8s;
        z-index: 3;
    }
    #restartHint.visible {
        opacity: 0.7;
    }
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
</style>
</head>

<body>
<canvas id="canvas"></canvas>
<div id="hud">
  <div id="score">Draw a circle!</div>
  <div id="details"></div>
  <div id="leaderboard" style="margin-top:12px;font-size:14px;color:#ccc;"></div>
  <div id="stats" style="margin-top:8px;font-size:14px;color:#aaa;"></div>
</div>
<div id="restartHint">Tap or click anywhere to try again</div>
<div id="instructions">Draw a perfect circle with your mouse or finger!</div>
<canvas id="particles"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const particleCanvas = document.getElementById("particles");
const pctx = particleCanvas.getContext("2d");

let w, h;
function resize() {
    w = window.innerWidth;
    h = window.innerHeight;
    const ratio = window.devicePixelRatio || 1;
    canvas.width = particleCanvas.width = window.innerWidth * ratio;
    canvas.height = particleCanvas.height = window.innerHeight * ratio;
    ctx.scale(ratio, ratio);
    pctx.scale(ratio, ratio);
}
window.addEventListener("resize", resize);
resize();

let drawing = false;
let points = [];
let particles = [];

let streak = parseInt(localStorage.getItem("streak") || "0");

let sessionScores = [];
let bestScore = parseFloat(localStorage.getItem("bestScore") || "0");

function updateBackgroundColor(score) {
    const hue1 = Math.max(0, Math.min(120, score * 1.2)); // 0â€“120 hue range
    const hue2 = hue1 + 60;
    document.body.style.background = 
      `linear-gradient(45deg, hsl(${hue1}, 70%, 15%), hsl(${hue2}, 70%, 25%))`;
    document.body.style.backgroundSize = "400% 400%";
    document.body.style.transition = "background 1.5s ease";
}

function start(e) {
    drawing = true;
    points = [];
    ctx.globalAlpha = 0.95; // smooth blend between strokes
    // ctx.clearRect(0, 0, w, h);  <-- removed for trail persistence
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.shadowBlur = 8;
    ctx.shadowColor = "#00ffff";
    ctx.beginPath();
    ctx.moveTo(e.clientX, e.clientY);
    document.getElementById("instructions").style.display = "none";
}

function draw(e) {
    if (!drawing) return;
    ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
    ctx.fillRect(0, 0, w, h);
    ctx.lineTo(e.clientX, e.clientY);
    ctx.strokeStyle = "hsl(" + (180 + Math.random() * 20) + ", 100%, 70%)";
    ctx.stroke();
    points.push({ x: e.clientX, y: e.clientY });
    spawnParticle(e.clientX, e.clientY);
}

function end() {
    if (!drawing) return;
    drawing = false;
    if (points.length < 20) return;
    scoreCircle();
}

canvas.addEventListener("mousedown", start);
canvas.addEventListener("mouseup", end);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("touchstart", e => start(e.touches[0]));
canvas.addEventListener("touchend", end);
canvas.addEventListener("touchmove", e => draw(e.touches[0]));

function updateLeaderboard(score) {
    let scores = JSON.parse(localStorage.getItem("circleScores") || "[]");
    scores.push(score);
    scores.sort((a, b) => b - a);
    scores = scores.slice(0, 5);
    localStorage.setItem("circleScores", JSON.stringify(scores));

    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>Top Circles</b><br>" + scores.map((s, i) =>
        `#${i + 1}: ${s.toFixed(1)}`
    ).join("<br>");
}

function scoreCircle() {
    let avgX = 0, avgY = 0;
    points.forEach(p => { avgX += p.x; avgY += p.y; });
    avgX /= points.length;
    avgY /= points.length;

    const radii = points.map(p => Math.hypot(p.x - avgX, p.y - avgY));
    const avgR = radii.reduce((a, b) => a + b) / radii.length;
    const variance = radii.reduce((sum, r) => sum + Math.abs(r - avgR), 0) / radii.length;
    const closure = Math.hypot(points[0].x - points.at(-1).x, points[0].y - points.at(-1).y);
    const closurePenalty = closure / avgR * 10;

    const rawScore = 100 - variance * 3 - closurePenalty;
    const score = Math.max(0, Math.min(100, rawScore));
    const details = `Variance: ${variance.toFixed(1)} | Closure: ${closure.toFixed(1)}`;

    let feedback;
    if (score >= 90) {
      feedback = "ðŸŒŸ Masterful!";
      streak++;
    } else if (score >= 75) {
      feedback = "ðŸ‘ Almost there!";
      streak = 0;
    } else if (score >= 50) {
      feedback = "Keep practicing!";
      streak = 0;
    } else {
      feedback = "Try steadier lines!";
      streak = 0;
    }
    localStorage.setItem("streak", streak);
    document.getElementById("score").innerText = `Score: ${score.toFixed(1)}/100`;
    document.getElementById("details").innerText = `${details} â€” ${feedback}${streak >= 2 ? " ðŸ”¥ x" + streak + " Streak!" : ""}`;

    sessionScores.push(score);
    const avgSession = sessionScores.reduce((a,b) => a + b, 0) / sessionScores.length;
    if (score > bestScore) {
      bestScore = score;
      localStorage.setItem("bestScore", bestScore);
    }
    document.getElementById("stats").innerText = 
      `Session Avg: ${avgSession.toFixed(1)} | Best: ${bestScore.toFixed(1)}`;

    ctx.beginPath();
    ctx.shadowBlur = 15;
    ctx.shadowColor = "rgba(0,255,255,0.8)";
    ctx.strokeStyle = "rgba(0,255,255,0.6)";
    ctx.lineWidth = 2.5;
    ctx.arc(avgX, avgY, avgR, 0, Math.PI * 2);
    ctx.stroke();
    ctx.shadowBlur = 0;

    popEffect(avgX, avgY, score);
    updateLeaderboard(score);
    updateBackgroundColor(score);
    if (score >= 90) {
        const msg = document.createElement("div");
        msg.innerText = "PERFECT!";
        msg.style.position = "fixed";
        msg.style.top = "50%";
        msg.style.left = "50%";
        msg.style.transform = "translate(-50%, -50%)";
        msg.style.fontSize = "72px";
        msg.style.color = "#0ff";
        msg.style.textShadow = "0 0 20px #0ff";
        msg.style.animation = "fadeOut 2s forwards";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
    }
    ctx.globalAlpha = 1;
}

function popEffect(x, y, score) {
    for (let i = 0; i < 30; i++) {
        particles.push({
            x, y,
            vx: (Math.random() - 0.5) * 6,
            vy: (Math.random() - 0.5) * 6,
            life: 60,
            color: score > 80 ? "#0ff" : score > 50 ? "#0f9" : "#f55"
        });
    }
}

function spawnParticle(x, y) {
    particles.push({
        x, y,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        life: 30,
        color: "rgba(255,255,255,0.5)"
    });
}

function animateParticles() {
    pctx.clearRect(0, 0, w, h);
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        pctx.fillStyle = p.color;
        pctx.beginPath();
        pctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
        pctx.fill();
        if (p.life <= 0) particles.splice(i, 1);
    }
    requestAnimationFrame(animateParticles);
}
animateParticles();

function resetGame() {
    pctx.clearRect(0, 0, w, h);
    particles = [];
    ctx.clearRect(0, 0, w, h);
    document.getElementById("score").innerText = "Draw a circle!";
    document.getElementById("details").innerText = "";
    document.getElementById("instructions").style.display = "block";
    points = [];
    ctx.shadowBlur = 0;
}
</script>
</body>
</html>
